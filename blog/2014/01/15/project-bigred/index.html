
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Project bigRed - SquareLemon</title>
	<meta name="author" content="Lee Brotherson">

	
	<meta name="description" content="Introduction Along with <a
href="https://www.rogers.com/web/Rogers.portal?_nfpb=true&_windowLabel=investor_1_1&investor_1_1_actionOverride=% &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="SquareLemon" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic' rel='stylesheet' type='text/css'>
</head>

<body>
	<div class="container">	

			<div class="mid-col-container">
				<div id="content" class="inner">
					<article class="post">
	<h1 class="title">Project bigRed</h1>
	<div class="entry-content"><h3>Introduction</h3>


<p>Along with <a
href="https://www.rogers.com/web/Rogers.portal?_nfpb=true&_windowLabel=investor_1_1&investor_1_1_actionOverride=%2Fportlets%2Fconsumer%2Finvestor%2FshowNewsDetail&investor_1_1yearInSelection=2014&investor_1_1BusiUnit=Wireless&investor_1_1NewsID=2110245869&investor_1_1selectedPageIndex=0&investor_1_1fromNewReleasePage=Wireless&_pageLabel=IR_LANDING">circa
1,948,000 other Canadian households</a> I use Rogers to provide my Internet
connection.  I had seen reports that Rogers had inserted
banners onto the top of webpages to notify users of new Terms &amp; Conditions or
that they were approaching their bandwidth limit for the month.  I had not
however seen any documents detailing how they were doing this, so I went
looking and found more than I was looking for.<!-- More --></p>

<h3>How does it work?</h3>


<p>The first piece of information to get to grips with was to discover what method
Rogers was using to do this.  I hypotheised that they may be using a
transparent proxy, falsifying DNS requests or creating some kind of captive
portal to achieve this.  Whatever the system was I began to work on the
assumption that our internet connections were probably being <a
href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">Man in the
Middle&rsquo;d</a> in some way.<br /><br />
Of course the only way to truely research this is to experience
it for myself, and noting that Rogers will alert you (using this method) once you
use 75% of your monthly bandwidth allowance I set to downloading and streaming
until I hit 75% usage, and sure enough.</p>

<br /><br />


<p><img src="/images/lemon_intercept.png"></p>

<br /><br />


<p>The first thing to note is that this appears to be fairly indiscriminate, it is
not limited to only Rogers own sites for example.  Which means this could work
from my own webserver; using my own webserver puts me at a significant
advantage as typically a user constitutes only one half of a connection with a 3rd party
constituting the other half.  In this instance, however, I can be in control of
both ends of the connection and am thus in possession of what data is sent and
recieved from both sides and can look for any differences.  So I set about
packetsniffing both client and server simultaniously during a transactions and
comparing the two, we can see what has changed.</p>

<p>Here is what I saw:<br />
<img src="/images/bigRed_packet_injection.png"><br /><br /></p>

<ul>
<li>The TCP 3-way handshake completes without any discrepancies, this is
immediately followed by a packet sent to the server which has been spoofed to
appear to originate from my home network with the RST, PSH and ACK flags set.
This is to make the server believe that my client has closed the connection and
serves two purposes; firstly it will surpress the further packets from the
server to the client and secondly it will mean that any further packets
arriving from client to server will be ignored.</li>

<li>The client, blissfully unaware that the connection to the server has been
closed proceeds to send it&#8217;s HTTP GET request to the web server.  Intestingly
despite the TCP connection being torn down the packet containing the HTTP
request is blocked and never reaches the server.  It would have been ignored
anyway assuming that the packet Rogers spoofed beat it in a race to the server,
which of course they can ensure due to being in-line.</li>

<li>The client recieves a spoofed packet which appears to be from the server
(containing correct sequence numbers, ttls, etc) containing a response to the
HTTP request (we will come back to that in a minute).</li>

<li>The connection is torn down, complete with further packet spoofing and
surpression</li>
</ul>


<br />


<p>Let me pick out the key points from this:<br /><br /></p>

<p>✔ Rogers are monitoring traffic on my connection<br /><br />
✔ Rogers are spoofing packets to appear to come from me<br /><br />
✔ Rogers are spoofing packets to me which appear to come from others<br /><br />
✔ Rogers are surpressing my packets to others<br /><br /></p>

<br />


<p>This logically leads to another question&hellip;<br /><br /></p>

<h3>What did they inject?</h3>


<p>By examining the packet capture I used to derive the above, we can see the
following data was sent as the reply to my HTTP request (whitespace added to
ease reading):</p>

<figure class='code'><figcaption><span>Injected HTML/JS </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">noscript</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">http</span><span class="o">-</span><span class="nx">equiv</span><span class="o">=</span><span class="s2">&quot;refresh&quot;</span> <span class="nx">content</span><span class="o">=</span><span class="s2">&quot;0;URL=http://64.71.251.10/noscript.pl?policy=72&amp;category=ByteCap-075&amp;&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/noscript&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;&lt;</span><span class="err">/title&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">webServer</span> <span class="o">=</span> <span class="s2">&quot;http://64.71.251.10&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/script&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;http://64.71.251.10/ByteCap-075-EO-English/index.js&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/head&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">noscript</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">frameset</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">frame</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;http://64.71.251.10/noscript.pl?policy=72&amp;category=ByteCap-075&amp;&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/frameset&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/noscript&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">body</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&quot;margin:0;&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="nx">Bulletin</span><span class="p">(</span><span class="s2">&quot;policy=72&amp;category=ByteCap-075&amp;&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/script&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="err">/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point there are a few things we should note that because of the way
this is injected the browser believes that it is recieving data from the
website that it originally tried to connect to.  This means that the browser
will:</p>

<p>✔ send Rogers all cookies assiciated with that site.<br /><br />
✔ execute Rogers scripts with the permissions &amp; context of that site.<br /><br /></p>

<p>In this case it is a script that tries to load one of two URLs depending on if
Javascript is enabled in the browser.  Or it would if Rogers had provided the
script referenced in the noscript section, as it is that page just 404&rsquo;s
(derp).<br /><br /></p>

<p>index.js is used to load another script, manager.js and to writes the Rogers
banner to the top of the page.<br /><br /></p>

<p>Due to a copyright notice at the top I am unsure as to if I can paste the
contents of manager.js (despite it being forced into my browser), however the
copyright notice does provide some really useful information.  Firstly it tells
us that the copyright holder and thus, presumably, manufacturer of whatever
device is performing the injection is <a
href="http://www.perftech.com/">Perftech</a>, also the copyright notice is for
the years 2005-2011 which could offer some clues as to the device and software
versions.<br /><br /></p>

<p>Further to this the Javascript lists out some config options including IP
address of the internal management interface (oops!).<br /><br /></p>

<p>Finally this script loads another script, bulletin.js which contains a number
of functions used to insert the Rogers banner.<br /><br /></p>

<h3>Where do they insert this?</h3>


<p>To me this is perhaps the most interesting part of this research.  At a high
level it&rsquo;s very simple&hellip; everywhere.  By this I mean all categories of sites:
search engines, blogs, personal sites, technical reference, pornography, etc.
But when we look at the individual connection level this question becomes way
more interesting&hellip;<br /><br /></p>

<p>You see Rogers cannot insert this on all http connections this is a banner at
the top, which loads the original page (unfettered) after it has loaded; for
this to work the connection needs to be allowed through.  Furthermore they
cannot intercept just any connection, this only works where the browser is
requesting an HTML page as injecting this into a http request for an image, for
example, would break sites horribly.  This also does not interfere with restful
interfaces, SOAP connections, etc which also use HTTP as a transport
mechanism.<br /><br /></p>

<p>Why is this so important?  Well the determination about an acceptable target
cannot be made until after the point that injection takes place meaning that it
is pre-determined in some way.  We can observe this by visiting a previously
unseen site and observing no banner, return a few minutes later and the banner
appears.  This means that Rogers are keeping some kind of record of targets
which can be injected without interfering with normal operation, other than the
presence of their banner.<br /><br /></p>

<p>But wait, it gets worse/better..<br /><br /></p>

<p>What happens if we visit a site that we have previously visited on our Rogers
Internet connection before injection began?  Days before injection began?  We
can observe banner injection on the first visit!<br /><br /></p>

<p>&hellip; and better &hellip;<br /><br /></p>

<p>In order to determine if the mimetype is something which can be injected,
Rogers need to be examining not only the request that the browser makes, but
the response it recieves too!<br /><br /></p>

<p>Luckily one of my test sites is operated by a friend of mine and is in
development and so has next to no traffic, they were happy to share the w3svc
logs with me so that I could review them to identify the device that Rogers is
using to index the acceptable targets.  What did I find?  Nothing.  No IP
addresses (other than my own) for Rogers, infact none from Canada at all.
Either Rogers has a database delivered to them via some other means or they are
actively logging HTTP data from connections, including connections which are
not even due to be injected with banners, just regular internet browsing.<br
/><br /></p>

<p>This is very easy to determine, I setup a new website never visited by anyone,
and loaded the page twice and observed the banner on the 2nd connection.<br
/><br /></p>

<p>Let&rsquo;s recap again:</p>

<p>✔ Rogers keeps track of URLs visited in order to create a list of targets which
can be easily injected.<br /><br />
✔ Rogers does this even when the user is not being currently injected,
presumably all the time.<br /><br />
✔ Rogers appears to be an equal opportunities injector, inserting banners (and
logging URLs) for a wide range of topics.<br /><br /></p>

<h3>So, this interception thing&#8230;</h3>


<p>I started to dig into how Rogers could be intercepting traffic and I noticed
something quite interesting when I started to lower the TTLs in various
packets.  HTTP connections take a distinctly different route through the Rogers
network to all other packets, presumably sending HTTP through a purpose built
interception network.  One of the networks is 64.71.251.0/24 on which
isns.rogers.com is hosted, this is the hostname of 64.71.251.10 which is
referenced in the injected script.</p>

<p>Sometime in December the routing changed, access lists were either modified or
removed meaning that not only were previously cloaked hops were de-cloaked, but
that you could see additional hops.  Not just different hops, additional hops.
This is particularly useful as it allows us to easily enumerate which services
are being intercepted.  By sending a SYN packet to each destination port of a
server I control on the internet with the same starting TTL, I can observe the
TTL at delivery time and determine which route was taken.  And the results&hellip;.
HTTP only.<br /><br /></p>

<p>This is (currently) very easy for any of Rogers customers to verify for
themselves.  In your OS of choice download tcptraceroute and select an IP
address on the internet to test.  The best choice for an IP is one which gets a
consistent route over multiple traditional UDP or ICMP traceroutes, rather than
one which takes varying routes.  Having performed a traditional traceroute, use
tcptraceroute on some random port&hellip; the same, right?  Now try tcptraceroute on
port 80 (HTTP), if your results are consistent with mine, you may have the
occasional timeout on a hop, but it should be noticeably different from any
other traceroute.<br /><br /></p>

<h3>Time for wild speculation</h3>


<p>I&rsquo;m actually going to leave the wild speculation to the Internet, it&rsquo;s way better at that than I am :)<br /><br /></p>

<p>But here are some thoughts:</p>

<ul>
<li>Who has access to the data harvested about browsing habits?  (3rd parties,
government, etc?)<br /><br /></li>
<li>What data is logged?<br /><br /></li>
<li>Rogers has an entirely different network to handle HTTP traffic in order to
perform this interception.  What else do they use this network for?  What
have I missed?<br /><br /></li>
</ul>

</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<!-- <a class="addthis_counter addthis_pill_style"></a> -->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



				</div>
			</div>
			<footer id="footer" class="inner">
				<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a> - 

    <a href="/about">Lee Brotherson</a>
 |
</footer>
			<script src="/javascripts/slash.js"></script>








	</div>
</body>
</html>
